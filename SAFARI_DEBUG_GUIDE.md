# 🧭 Safari 浏览器调试指南

## 启用 Safari 开发者工具

### 步骤 1: 启用开发者菜单 (首次使用)

1. **打开 Safari 偏好设置**
   - 菜单栏: Safari → 偏好设置... (或 设置...)
   - 快捷键: `Command + ,`

2. **切换到"高级"标签**
   - 点击偏好设置窗口顶部的 **高级** 标签

3. **启用开发菜单**
   - 勾选 ✅ **"在菜单栏中显示'开发'菜单"**
   
4. **验证**
   - 关闭偏好设置
   - 菜单栏应该出现 **"开发"** 菜单

---

## 打开控制台的 3 种方法

### 方法 1: 快捷键 (最快) ⭐

```
Command + Option + C
```

按一次打开，再按一次关闭。

### 方法 2: 菜单

1. 点击菜单栏的 **开发**
2. 选择 **显示 Web 检查器**
3. 点击底部工具栏的 **控制台** 标签

### 方法 3: 右键菜单

1. 在网页上右键点击 (或 Control + 点击)
2. 选择 **检查元素**
3. 点击 **控制台** 标签

---

## Safari 控制台界面说明

打开后，您会看到类似这样的界面：

```
┌─────────────────────────────────────────────────────────────┐
│ Safari 主窗口 - localhost                                    │
│ ◄ ► 🔄 🏠 http://localhost:3000                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【您的网页内容显示在这里】                                   │
│                                                             │
├═════════════════════════════════════════════════════════════┤
│ 元素 | 控制台 | 源代码 | 网络 | 时间线 | 存储                │  ← 标签栏
├─────────────────────────────────────────────────────────────┤
│ 📊 控制台面板                                                │
│                                                             │
│ 🔍 过滤 [搜索框...]           [日志 信息 警告 错误]           │
│                                                             │
│ > ========== 开始视频处理 ==========                         │
│ > 上传的视频: test.mp4 (4.34 MB)                            │
│ > 方版模板: template.jpg                                    │
│ > 正在发送请求到 /api/process...                            │
│ > 收到响应, 状态码: 200                                      │
│ > ✅ 视频处理完成                                            │
│ >                                                           │
│ > _                                      ← 命令行输入区       │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键功能说明

### 1. 日志级别筛选

在控制台右侧有筛选按钮：

- **全部** - 显示所有消息
- **日志** - 只显示 console.log()
- **信息** - 只显示 console.info()
- **警告** - 只显示 console.warn() (黄色)
- **错误** - 只显示 console.error() (红色)

### 2. 清空控制台

- 点击 🗑️ (垃圾桶图标)
- 或按 `Command + K`

### 3. 搜索日志

- 使用顶部的搜索框
- 输入关键词，如 "错误" 或 "完成"

### 4. 保留日志

- 勾选 "保留日志" 选项
- 页面刷新后日志不会被清空

---

## 调试您的视频处理应用

### 打开控制台后的操作流程：

1. **打开网页**
   ```
   http://localhost:3000
   ```

2. **打开控制台**
   ```
   Command + Option + C
   ```

3. **清空现有日志** (可选)
   ```
   Command + K
   ```

4. **上传文件并开始渲染**
   - 上传竖版视频
   - 上传至少一个模板 (方版或横版)
   - 点击 "开始生成视频"

5. **观察日志输出**

### 正常情况的日志：

```javascript
========== 开始视频处理 ==========
上传的视频: 4_1763388326.mp4 (4.34 MB)
方版模板: 31763388299__pic_thumb.jpg
横版模板: 21763388298__pic_thumb.jpg
正在发送请求到 /api/process...
收到响应, 状态码: 200
✅ 视频处理完成: {
  success: true,
  message: "视频处理完成",
  videos: [
    {type: "square", url: "/api/output/square_1700123456.mp4", filename: "square_1700123456.mp4"},
    {type: "landscape", url: "/api/output/landscape_1700123456.mp4", filename: "landscape_1700123456.mp4"}
  ]
}
========== 处理结束 ==========
```

### 错误情况的日志：

```javascript
========== 开始视频处理 ==========
上传的视频: test.mp4 (4.34 MB)
方版模板: template.jpg
正在发送请求到 /api/process...
收到响应, 状态码: 500
❌ 服务器返回错误: {
  error: "视频处理失败",
  details: "spawn ENOENT"
}
```

---

## 查看网络请求

除了控制台，您还可以查看网络请求详情：

1. **切换到网络标签**
   - 快捷键: `Command + Option + N`
   - 或点击 **网络** 标签

2. **刷新页面或触发请求**
   - 点击 "开始生成视频"

3. **查找 process 请求**
   - 在列表中找到 `process`
   - 点击查看详情

4. **检查请求信息**
   - **请求** 标签: 查看上传的文件
   - **响应** 标签: 查看服务器返回的数据
   - **时间线** 标签: 查看请求耗时

---

## Safari 特殊问题处理

### 问题 1: 看不到"开发"菜单

**解决方案:**
1. 确认已在 Safari 偏好设置 → 高级 中启用
2. 重启 Safari
3. 如果仍看不到，尝试更新 macOS

### 问题 2: 控制台日志太多

**解决方案:**
1. 使用右侧的筛选按钮
2. 使用搜索框过滤
3. 清空控制台 (Command + K)

### 问题 3: 日志显示不全

**解决方案:**
1. 点击日志条目展开详情
2. 右键日志 → "在单独窗口中打开"
3. 调整控制台面板大小

### 问题 4: Safari 与 Chrome 日志格式不同

**说明:**
- Safari 的对象展示方式可能与 Chrome 不同
- 某些 console API 可能显示略有差异
- 功能上完全等效

### 问题 5: 上传接口返回 500，提示缺少 `VERCEL_BLOB_READ_WRITE_TOKEN`

**现象:**
- 网络面板中的 `/api/blob-upload-url` 请求为 500。
- 控制台出现 `"无法生成 VERCEL_BLOB_READ_WRITE_TOKEN"`、`Failed to load resource: 500` 等报错。

**原因:**
- 该接口会向 Vercel Blob 请求一次性上传凭证；若环境变量中没有可写令牌，就无法生成 URL。

**解决方式:**
1. **首选：提供真实令牌**
   - 在 Vercel 仪表盘 → Storage → Blob 中创建 **Read & Write Token**。
   - 在 `.env.local` 中新增：
     ```
     VERCEL_BLOB_READ_WRITE_TOKEN=xxxxx
     ```
   - 重新启动 `pnpm dev` 并刷新页面。
2. **备选：启用本地兜底上传（开发模式默认开启）**
   - 当未设置令牌且当前不在生产环境时，后端会自动改用 `/api/local-upload`。
   - 文件会被写入 `public/local-uploads/`，页面可直接以 `http://localhost:3000/local-uploads/...` 形式访问。
   - 通过设置 `ALLOW_LOCAL_FILE_UPLOAD=false` 可以强制关闭该兜底模式。
3. **安全提示**
   - `public/local-uploads/` 已在 `.gitignore` 中，防止大文件被提交。
   - 若切换回 Vercel Blob，请清空该目录以释放磁盘空间。

---

## Safari 开发者工具快捷键速查

| 功能 | 快捷键 |
|------|--------|
| Web 检查器 | `Command + Option + I` |
| 控制台 | `Command + Option + C` |
| 网络 | `Command + Option + N` |
| 元素检查 | `Command + Option + E` |
| 清空控制台 | `Command + K` |
| 重新加载页面 | `Command + R` |
| 强制重新加载 | `Command + Shift + R` |
| 关闭标签 | `Command + W` |
| 偏好设置 | `Command + ,` |

---

## 调整控制台显示

### 改变控制台位置

右键点击标签栏 → 选择：
- **停靠到底部** (默认)
- **停靠到右侧**
- **停靠到左侧**
- **在单独窗口中显示**

### 调整控制台大小

- 拖动分隔线调整高度/宽度
- 双击分隔线快速最大化/恢复

---

## 完整调试流程示例

### 场景：视频一直卡在"渲染中..."

#### 第 1 步：打开双窗口监控

**窗口 1 - Safari (浏览器控制台):**
```
Command + Option + C  (打开控制台)
Command + K          (清空日志)
```

**窗口 2 - 终端 (服务器日志):**
```bash
# 找到运行 pnpm dev 的终端窗口
# 清空终端 (可选): Command + K
```

#### 第 2 步：触发视频处理

1. 在网页中上传文件
2. 点击 "开始生成视频"
3. 同时观察两个窗口

#### 第 3 步：对比日志

**Safari 控制台应该显示:**
```
========== 开始视频处理 ==========
...
正在发送请求到 /api/process...
```

**终端应该显示:**
```
========================================
📹 开始处理视频上传请求...
...
```

#### 第 4 步：诊断问题

根据日志判断问题出在哪里：

- ✅ Safari 有日志，终端也有日志 → 查看具体错误信息
- ❌ Safari 有日志，终端没有 → 服务器未收到请求
- ❌ Safari 没有日志 → 前端 JavaScript 错误
- ✅ 都有日志但卡住 → 查看终端的 FFmpeg 错误

---

## 提示和技巧

### 💡 技巧 1: 保存控制台日志

1. 右键点击控制台 → **保存**
2. 或全选 (Command + A) → 复制 (Command + C)

### 💡 技巧 2: 过滤特定日志

在搜索框输入：
- `开始` - 查看开始相关的日志
- `✅` - 查看成功的日志
- `❌` - 查看错误的日志
- `进度` - 查看进度相关的日志

### 💡 技巧 3: 实时监控

勾选 "保留日志" 选项，这样：
- 页面刷新后日志不会消失
- 可以对比多次操作的日志

### 💡 技巧 4: 导出网络请求

在网络标签中：
1. 右键点击请求
2. 选择 **拷贝为 cURL**
3. 可以在终端重放请求

---

## 故障排查清单

使用 Safari 调试时，确认以下项目：

- [ ] 已在 Safari 偏好设置中启用开发者菜单
- [ ] 能看到菜单栏中的"开发"菜单
- [ ] 控制台已打开 (Command + Option + C)
- [ ] 控制台标签已选中（不是元素或网络标签）
- [ ] 没有勾选任何日志级别过滤（或只勾选"全部"）
- [ ] 服务器终端窗口也在可见位置
- [ ] 已清空旧的日志便于查看新日志

---

## 对比：Safari vs Chrome 控制台

| 功能 | Safari | Chrome |
|-----|--------|--------|
| 打开快捷键 | `Cmd+Opt+C` | `Cmd+Opt+J` (Mac) / `F12` (Win) |
| 清空控制台 | `Cmd+K` | `Cmd+K` 或 `Ctrl+L` |
| 对象展示 | 可展开 | 可展开 |
| 网络标签 | `Cmd+Opt+N` | 单独标签 |
| 性能 | 优秀 | 优秀 |
| 兼容性 | macOS/iOS | 全平台 |

两者功能基本相同，选择您熟悉的即可！

---

**现在您可以开始调试了！** 🚀

如果遇到问题，请：
1. 截图 Safari 控制台
2. 截图服务器终端
3. 提供这两张截图，我就能快速帮您诊断问题！

