# 📝 日志系统说明

## 概述

您的视频处理系统现在配备了**完整的日志系统**,可以帮助您快速诊断问题。

---

## 🎯 日志位置

### 1. 浏览器控制台日志 (前端)

**如何查看:**
- 按 `F12` 打开开发者工具
- 切换到 **Console** 标签

**日志内容:**
```javascript
========== 开始视频处理 ==========
上传的视频: your_video.mp4 (4.34 MB)
方版模板: template_square.jpg
横版模板: template_horizontal.jpg
正在发送请求到 /api/process...
收到响应, 状态码: 200
✅ 视频处理完成: {success: true, videos: Array(2)}
========== 处理结束 ==========
```

**文件位置:** `app/page.tsx` (第 67-89 行)

---

### 2. 服务器终端日志 (后端)

**如何查看:**
- 找到运行 `pnpm dev` 的终端窗口
- 日志会自动输出到该终端

**日志内容示例:**

#### 请求开始
```
========================================
📹 开始处理视频上传请求...
时间: 2024/11/17 下午3:45:23
========================================
```

#### 文件解析
```
⏳ 正在解析上传文件...
✅ 文件解析完成
📦 解析到的文件字段: ['video_vertical', 'template_square']
📝 文件详情: {
  "video_vertical": {
    "size": 4567890,
    "filepath": "/tmp/upload_123.mp4",
    ...
  }
}
```

#### 文件验证
```
🔍 验证文件路径...
竖版视频路径: /tmp/upload_123.mp4
方版模板路径: /tmp/upload_456.jpg
横版模板路径: ❌ 未找到
✅ 文件路径验证通过
```

#### FFmpeg 处理
```
🎬 开始生成方版视频...
   输出路径: /tmp/square_1700123456789.mp4

🎥 FFmpeg 开始处理方版视频
命令: ffmpeg -i /tmp/upload_456.jpg -i /tmp/upload_123.mp4...
📊 方版视频处理进度: 15.5%
📊 方版视频处理进度: 32.1%
📊 方版视频处理进度: 48.7%
📊 方版视频处理进度: 65.3%
📊 方版视频处理进度: 82.9%
✨ 方版视频 FFmpeg 处理完成
✅ 方版视频生成成功!
```

#### 处理完成
```
⏳ 等待所有视频处理任务完成...

🎉 所有视频生成完成!
生成的视频数量: 2
```

#### 错误情况
```
❌❌❌ 视频处理失败 ❌❌❌
错误类型: Error
错误信息: spawn ENOENT
错误堆栈: Error: spawn ENOENT
    at Process.ChildProcess._handle.onexit...
========================================
```

**文件位置:** `app/api/process/route.ts`

---

## 🔧 日志级别说明

| 图标 | 含义 | 示例 |
|-----|------|------|
| 📹 | 流程开始 | 开始处理视频上传请求 |
| ⏳ | 正在处理 | 正在解析上传文件 |
| ✅ | 成功完成 | 文件解析完成 |
| 🔍 | 检查验证 | 验证文件路径 |
| 🎬 | 视频生成 | 开始生成方版视频 |
| 🎥 | FFmpeg | FFmpeg 开始处理 |
| 📊 | 进度更新 | 视频处理进度: 50% |
| ✨ | 步骤完成 | FFmpeg 处理完成 |
| 🎉 | 全部完成 | 所有视频生成完成 |
| ❌ | 错误警告 | 处理失败 |
| 💥 | 严重错误 | FFmpeg 处理失败 |

---

## 🚀 快速诊断流程

### 当遇到"一直渲染"问题时:

#### 第 1 步: 检查浏览器控制台

```bash
# 打开浏览器控制台 (F12)
# 检查是否有以下日志:

✅ 有 "开始视频处理" → 前端正常,继续第 2 步
❌ 没有日志 → 前端 JavaScript 错误,检查是否有红色错误信息
```

#### 第 2 步: 检查请求是否发送

```bash
# 在浏览器控制台查看:

✅ 看到 "正在发送请求到 /api/process..." → 请求已发送,继续第 3 步
❌ 没看到 → 检查网络连接或 JavaScript 错误
```

#### 第 3 步: 检查服务器响应

```bash
# 在浏览器控制台查看:

✅ 看到 "收到响应, 状态码: 200" → 请求成功,继续第 4 步
❌ 状态码不是 200 (如 400, 500) → 继续第 5 步查看服务器日志
❌ 一直没有 "收到响应" → 服务器可能崩溃或未运行
```

#### 第 4 步: 检查服务器终端

```bash
# 切换到运行 pnpm dev 的终端

✅ 看到完整的处理流程 + "🎉 所有视频生成完成!" → 系统正常
❌ 看到错误信息 → 根据错误类型解决(见下方)
❌ 没有任何日志 → 服务器未收到请求,检查网络或服务器状态
```

#### 第 5 步: 根据错误类型解决

```bash
# 常见错误:

💥 "spawn ENOENT" → FFmpeg 未安装或路径错误
   解决: brew install ffmpeg (macOS)

❌ "缺少竖版视频文件" → 文件上传失败
   解决: 检查文件格式和大小

❌ "Invalid data found" → 视频格式不支持
   解决: 使用标准 MP4 或 MOV 格式

💥 "File size exceeds maximum" → 文件太大
   解决: 压缩视频或增加文件大小限制
```

---

## 🛠️ 测试工具

### 1. 系统环境测试

运行系统检测脚本:

```bash
node test-system.js
```

这将检测:
- ✅ Node.js 版本
- ✅ npm 包安装情况
- ✅ FFmpeg 可用性
- ✅ 临时目录权限

### 2. 手动测试 API

使用 curl 测试 API:

```bash
# 测试服务器是否运行
curl http://localhost:3000/api/process

# 应该返回 405 (Method Not Allowed) 因为需要 POST
```

---

## 📊 日志文件位置总览

| 组件 | 文件 | 日志位置 | 关键日志 |
|-----|------|---------|---------|
| 前端上传 | `app/page.tsx` | 浏览器控制台 | 67-89 行 |
| API 路由 | `app/api/process/route.ts` | 服务器终端 | 203-324 行 |
| 方版视频 | `app/api/process/route.ts` | 服务器终端 | 120-138 行 |
| 横版视频 | `app/api/process/route.ts` | 服务器终端 | 183-201 行 |
| 文件下载 | `app/api/output/[filename]/route.ts` | 服务器终端 | 34, 47, 67 行 |

---

## 🎯 最常见的 3 个问题

### 1. FFmpeg 未安装 (占 60%)

**症状:**
```
💥 方版视频 FFmpeg 处理失败!
错误信息: spawn ENOENT
```

**解决:**
```bash
# macOS
brew install ffmpeg

# 验证安装
ffmpeg -version

# 重启开发服务器
pnpm dev
```

---

### 2. 文件上传失败 (占 25%)

**症状:**
```
⏳ 正在解析上传文件...
❌❌❌ 视频处理失败 ❌❌❌
错误信息: File size exceeds maximum
```

**解决:**
- 检查视频大小 (当前限制 500MB)
- 压缩视频
- 或修改 `app/api/process/route.ts` 第 62 行增加限制

---

### 3. 视频格式不支持 (占 15%)

**症状:**
```
💥 方版视频 FFmpeg 处理失败!
错误信息: Invalid data found when processing input
```

**解决:**
- 确保视频是 MP4 或 MOV 格式
- 使用标准视频编码 (H.264)
- 尝试使用视频转换工具重新编码

---

## 📚 更多资源

- **完整调试指南:** `DEBUG_GUIDE.md`
- **系统测试脚本:** `test-system.js`
- **项目文档:** `VIDEO_PROCESSING_README.md`

---

## 💡 调试技巧

### 增加自定义日志

在任何你想调试的位置添加:

```typescript
console.log('🔍 调试点 [描述]:', 变量名, 其他信息)
```

### 捕获更多错误细节

```typescript
try {
  // 你的代码
} catch (error) {
  console.error('❌ 错误发生在 [位置]')
  console.error('错误类型:', error.constructor.name)
  console.error('错误信息:', error.message)
  console.error('错误堆栈:', error.stack)
}
```

### 实时监控文件

```bash
# macOS/Linux
watch -n 1 "ls -lh /tmp/*.mp4"

# 查看临时文件变化
```

---

## ✅ 预检清单

在每次测试前:

- [ ] Next.js 开发服务器正在运行 (`pnpm dev`)
- [ ] 浏览器开发者工具已打开 (F12)
- [ ] 服务器终端窗口可见
- [ ] FFmpeg 已安装 (`ffmpeg -version`)
- [ ] 文件格式正确 (MP4/MOV 视频, JPG/PNG 图片)
- [ ] 文件大小合理 (< 500MB)

---

**提示:** 90% 的问题可以通过查看日志快速定位! 🎯

